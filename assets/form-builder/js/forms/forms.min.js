//#Copyright (c) 2016-2017 Rafal Marguzewicz pceuropa.net
"use strict";var h={version:"1.0.1",isString:function(a){return"string"==typeof a||a instanceof String},is:function(a){return null!==a&&void 0!==a&&""!==a},isObject:function(a){return"object"==typeof a},clearObj:function(a){for(var b in a)null!==a[b]&&void 0!==a[b]||delete a[b];return a},each:function(a,b){var c=0;for(c;c<a.length;c++)b(c,value)},setAttribute:function(a,b,c){(this.isObject(a)||this.isString(b)||this.is(c))&&a.setAttribute(b,c)},clone:function(a){var b={};for(var c in a)if(b[c])if(Array.isArray(a[c]))for(var d=0;d<a[c].length;d++)b[c][d]=a[c][d];else b[c]=a[c];return b},getName:function(){var a=/function (.{1,})\(/,b=a.exec(this.constructor.toString());return b&&b.length>1?b[1]:""},capitalizeFirstLetter:function(a){return a.charAt(0).toUpperCase()+a.slice(1)}};!function(a){a.fn.extend({donetyping:function(b,c){c=c||1e3;var d,e=function(a){d&&(d=null,b.call(a))};return this.each(function(b,f){a(f).on("keyup keypress paste",function(a){d&&clearTimeout(d),d=setTimeout(function(){e(f)},c)}).on("blur",function(){e(f)})})}})}(jQuery),String.prototype.replaceAll=function(a,b){return this.replace(new RegExp(a,"g"),b)};var MyFORM=MyFORM||{};MyFORM=function(){console.log("form: 1.1.0");var a=function(){this.url=null,this.title="FormBuilder",this.action="",this.method="post",this.language="English",this.body=[]};return a.prototype={hello:"hello Vege",questionsNames:[],constructor:a,viewMode:"html",time_out:1,div_form:$("#preview-form"),map:{index:"0",row:"0"},config:{get:!1,save:!0,autosave:!1,create_url:document.URL,update_url:document.URL},init:function(b){return this.config=b||this.config,this.get(),console.log(this.config),this.config.autosave&&(this.autosaveButton(),a.prototype.time_out=1e3),MyFORM.controller(this,new MyFORM.field.factory)},autosaveButton:function(){this.config.autosave&&$("#save-form").html("autosave mode").prop("disabled",!0)},clear:function(a){var b={};for(var c in a)if(a.hasOwnProperty(c)&&a[c]){if("name"===c&&(a[c]=this.filter(a[c])),"items"===c)for(var d=0;d<a[c].length;d++)""===a[c][d].value&&(a[c][d].value=d+1);b[c]=a[c]}return b},filter:function(a){var b=this.questionsNames;a=a.replace(new RegExp(/\W/,"g"),"_");for(var c in b)b[c]===a&&(a+="_2");return b.push(a),a},scenerio:function(){return this.config.save&&this.config.autosave},get:function(){var a=this;this.config.get&&$.getJSON(document.URL,function(b){console.log("upload from base correct"),a.generate(b)})},save:function(){var a=this,b=$('meta[name="csrf-token"]').attr("content"),c={};return!!this.config.save&&(c={form_data:JSON.stringify(a),title:a.title,url:a.url,_csrf:b},void $.post(document.URL,c,function(b){b.success===!0&&(console.log("save in base correct"),a.successSave(),b.url&&(window.location.href=b.url))}))},editName:function(a,b){var c=this,d=$('meta[name="csrf-token"]').attr("content"),e={};this.config.autosave&&(e={change_name:{old:a,new:b,body:JSON.stringify(c)},_csrf:d},$.post(document.URL,e,function(a){a.success===!0&&console.log("new name change correct")}))},successSave:function(){var a=$("#save-form"),b=a.clone();a.addClass("btn-success").prop("disabled",!0).text("Saved form correctly"),window.setTimeout(function(){a.replaceWith(b)},1111)},add:function(a){try{a.hasOwnProperty("field")&&(this.body.push([this.clear(a)]),this.config.autosave&&$.post(document.URL,{add:a}),this.render())}catch(a){console.log(a),alert("Error add field to form: bad data")}},cloneField:function(a,b){var c=this.body[a][b],d=jQuery.extend(!0,{},c);d.hasOwnProperty("label")&&(d.label=c.label+"_2"),d.name=c.name+"_2",this.body[a].splice(b+1,0,d),this.config.autosave&&d.hasOwnProperty("name")&&$.post(document.URL,{add_field:d}),this.render()},deleteField:function(a,b){var c=this.body[a][b];try{this.body[a].splice(b,1)&&(this.config.autosave&&this.config.save&&$.post(document.URL,{delete:c.name},function(a){1!=a.success&&console.log(a)}),console.log("Delete item [",a,b,"]"),this.render())}catch(c){console.log("Item [",a,b,"] not exsist")}},addItem:function(){console.log("add item to field in form");try{for(var a=document.getElementById("update").getElementsByClassName("itemField"),b={},c=0;c<a.length;c++)b[a[c].id]="checkbox"===a[c].type?a[c].checked:a[c].value;this.body[this.map.row][this.map.index].items.push(b),this.render()}catch(a){console.log(a),alert("Error add item to field: bad id of div")}},cloneItem:function(a,b,c){var d={},e=this.body[a][b].items[c];for(var f in e)e.hasOwnProperty(f)&&(d[f]=e[f]);this.body[a][b].items.splice(c,0,d),this.render()},deleteItem:function(a,b,c){this.body[a][b].items.splice(c,1),this.render()},generate:function(a){this.title=a.title||"",this.action=a.action||"",this.method=a.method||"",this.id=a.id||"",this.body.class=a.class||"",this.body=a.body||{},0!==this.body.length&&this.render("off")},render:function(){switch(a.prototype.viewMode){case"html":this.div_form.html(this.html()),this.sort(this);break;case"text":this.div_form.html("<pre><code> </code></pre>").find("code").text(this.html());break;case"json":this.div_form.html("<pre><code> </code></pre>").find("code").text(JSON.stringify(this,null,4));break;case"yii2":this.div_form.html("<pre><code> </code></pre>").find("code").text("Yii2");break;default:throw"View mode error, check form.viewMode"}console.log("render"),this.config.autosave&&"off"!==arguments[0]&&this.save(),this.preventNotValidaData()},preventNotValidaData:function(){$("#save-form").prop("disabled",!(h.isString(this.title)&&h.isString(this.url)))},attr:function(){for(var a,b="",c=arguments.length,a=0;a<c;a+=1)b+=this[arguments[a]+"Attr"]();return b},idAttr:function(){return this.id?' id="'+this.id+'"':""},classAttr:function(){return this.class?' class=" '+this.class+'"':' class=""'},rows:function(){var a="",b=this;return 0==b.body.length?"":(h.each(b.body,function(c){a+=b.row(c)}),a)},row:function(a){return'\n<div id="row'+a+'" class="row">\n'+this.fields(a)+" \n</div>\n"},fields:function(a){for(var b="",c=0,d=this.body[a].length;c<d;c++)b+=this.field(a,c);return b},field:function(b,c){var d=this.body[b][c],e=new MyFORM.field.factory(d);return"html"===a.prototype.viewMode&&(e.divEnd=function(){return a.prototype.edit(b,c)+"\n</div>\n"}),e.html()},html:function(){return'<form  action="'+this.action+'" method="'+this.method+'" '+this.attr("id","class")+">"+this.rows()+"\n</form>"},setEdit:function(b,c){a.prototype.beforeEndDiv=this.edit(b,c)},setView:function(b){a.prototype.viewMode=b||""},edit:function(b,c){function d(a,b,c){return'<span class="glyphicon '+c+'" data-row="'+a+'" data-index="'+b+'" aria-hidden="true"></span>'}return"html"===a.prototype.viewMode?'<div class="edit-field pull-right">'+d(b,c,"edit glyphicon-pencil")+d(b,c,"clone glyphicon-duplicate")+d(b,c,"delete glyphicon-trash")+"</div>":null},sort:function(){for(var a=this,b=function(a){return a.substring(3)},c=this.body.length;c--;){var d=document.getElementById("row"+c);Sortable.create(d,{group:"row",animation:0,ghostClass:"ghost",onAdd:function(c){var d=b(c.from.id),e=b(c.target.id),f=c.oldIndex,g=c.newIndex,h=a.body[d].splice(f,1)[0];a.body[e].splice(g,0,h),a.render()},onUpdate:function(c){var d=b(c.from.id),e=c.oldIndex,f=c.newIndex;a.body[d].splice(f,0,a.body[d].splice(e,1)[0]),a.render()}})}}},{Form:a}}(),MyFORM.field=function(){console.log("field: 1.0.0");var a=function(a){this.body=a||{},this.init()};a.prototype={constructor:a,view:!0,init:function(){this.set(MyFORM.field[this.body.field])},uiHelper:function(){var a=this;!function(){for(var c=document.getElementById(a.body.field).getElementsByClassName("data-source"),d=0;d<c.length;d++)a.body[c[d].id]="checkbox"===c[d].type?c[d].checked:c[d].value}(),function(){""==$("#"+a.body.field+" #name").val()&&($(this).css("color","red"),$(this).val(a.body.field))}()},set:function(a){a=a||{};for(var b in a)this[b]=a[b]},addItem:function(){try{for(var a=document.getElementById(this.body.field).getElementsByClassName("itemField"),b={},c=0;c<a.length;c++)b[a[c].id]="checkbox"===a[c].type?a[c].checked:a[c].value;this.body.items.push(b),this.render()}catch(a){console.log(a),alert("Error add item to field: bad id of div")}},render:function(){var a=$("#preview-field"),b=this;this.view?a.html("<p>Preview field: (<a>html</a>) </p>"+b.html()):a.html("<p>Preview field: (<a>text</a>)</p><pre><code> </code></pre></p>").find("code").text(b.html()),a.find("a").click(function(){b.view=!b.view,b.render()})},renderUpdateItemField:function(){var a=this;this.body.hasOwnProperty("items")&&this.body.items.length&&$("#"+a.body.field+" .select-item-to-change").html(function(){var b=0,c="",d="";for(b;b<a.body.items.length;b++)c=a.body.items[b].text?a.body.items[b].text:"",d+='<option value="'+b+'">'+(b+1)+". "+c+"</option>";return'<select class="change-item form-control input-sm"> <option selected>Change item</option>'+d+"</select>"}())},is:function(a){return a?a:""},typeAttr:function(){return this.body.type?' type="'+this.body.type+'"':""},labelAttr:function(){var a="";return this.body.require&&(a=" *"),this.body.label?"\n\t<label>"+this.body.label+a+"</label>":""},nameAttr:function(a){var a=a||!1;return a?this.body.name?' name="'+this.body.name+'[]"':"":this.body.name?' name="'+this.body.name+'"':""},valueAttr:function(){return this.body.value?' value="'+this.body.value+'"':" "},placeholderAttr:function(){return this.body.placeholder?' placeholder="'+this.body.placeholder+'"':""},idAttr:function(){return this.body.id?' id="'+this.body.id+'"':""},classAttr:function(){return this.body.class?' class="form-control '+this.body.class+'"':' class="form-control"'},dataAttr:function(){return this.body.data?' data="'+this.body.data+'"':""},rowsAttr:function(){return this.body.rows?' rows="'+this.body.rows+'"':""},checkedAttr:function(){return this.body.checked?" checked":""},requireAttr:function(){return this.body.require?" required":""},checkedAttr:function(){return this.body.require?" checked":""},helpBlockAttr:function(){return this.body.helpBlock?'\n\t<span class="help-block">'+this.body.helpBlock+"</span>":""},div:function(){return'<div class="form-group '+this.body.width+'">'},divEnd:function(){return"\n</div>"},attr:function(){for(var a,b="",c=arguments.length,a=0;a<c;a+=1)b+=this[arguments[a]+"Attr"]();return b},el:function(a){for(var b,d,c="",e=arguments.length,b=1;b<e;b+=1)d=arguments[b]+"El",c+=this[d](a);return c},labelEl:function(a){var b=this.body.items[a].text;return b?b:""},valueEl:function(a){var b=this.body.items[a].value;return b?' value="'+b+'"':' value="'+(a+1)+'"'},idEl:function(a){var b=this.body.items[a].id;return b?' id="'+b+'"':""},classEl:function(a){var b=this.body.items[a].class;return b?' class="'+b+'"':""},checkedEl:function(a){return this.body.items[a].checked?" checked":""},selectedEl:function(a){return this.body.items[a].checked?" selected":""},requireEl:function(){return this.require?" required":""},inputs:function(){var a=0,b="";for("undefined"==typeof this.body.items&&(this.body.items=[]),a;a<this.body.items.length;a++)b+=this.input(a);return b},inputHtml:function(a,b){return'<input type="'+this.is(a)+'"'+this.attr("name")+this.el(b,"value","id","class","checked","require")+">"+this.labelEl(b)},editElement:function(a){return Form.prototype.editEl.call(this,a)},glyphicon:function(a,b){return'<span class="glyphicon '+b+'" data-index="'+a+'" aria-hidden="true"></span>'},deleteItem:function(a){if(!a)throw console.log("Delete item by index:"),a;this.body.items.splice(a,1),this.render()},cloneItem:function(a){if(!a)throw console.log("Clone item by index:"),a;var b=this.body.items[a];this.body.items.splice(a,0,b),this.render()}};var b={html:function(){var a=document.createElement("input");return a.setAttribute("name",this.body.name),console.log(a),a.outerHTML}},b={html:function(){return this.div()+this.labelAttr()+"\n\t<input"+this.attr("name","type","value","placeholder","id","class","data","require")+">"+this.helpBlockAttr()+this.divEnd()}},c={html:function(){var a=this.value?this.value:"";return this.div()+this.labelAttr()+"\t<textarea "+this.attr("name","id","class","data","rows","placeholder","require")+">"+a+"</textarea>"+this.helpBlockAttr()+this.divEnd()}},d={html:function(){return this.div()+this.labelAttr()+this.inputs()+this.helpBlockAttr()+this.divEnd()},labelAttr:function(){var a="";return this.body.require&&(a=" *"),this.body.label?"\t<p>"+this.body.label+a+"</p>":""},input:function(a){return'\n\t<div class="radio"><label>'+this.inputHtml("radio",a)+"<label></div>"}},e={html:function(){return this.div()+this.labelAttr()+this.inputs()+this.helpBlockAttr()+this.divEnd()},input:function(a){return'\n\t<div class="checkbox"><label><input type="checkbox"'+this.nameAttr("multi")+this.el(a,"value","id","class","checked","require")+">"+this.labelEl(a)+"<label></div>"}},f={html:function(){return this.div()+this.labelAttr()+"\n\t<select "+this.attr("id","class","name","require")+">"+this.inputs()+"\n\t</select>"+this.helpBlockAttr()+this.divEnd()},input:function(a){return"\n\t\t<option "+this.el(a,"value","selected")+">"+this.labelEl(a)+"</option>"}},g={classAttr:function(){return this.body.class?" "+this.body.class:""},div:function(){return"<div "+this.idAttr()+' class="form-group '+this.body.width+this.classAttr()+'">'},html:function(){return this.div()+this.is(this.body.description)+this.divEnd()}},h={html:function(){return this.div()+'\t<button type="submit" class="btn btn-default">'+this.is(this.body.label)+"</button>"+this.divEnd()}};return{factory:a,input:b,textarea:c,radio:d,checkbox:e,select:f,description:g,submit:h}}(),MyFORM.template=function(a){var c=[{title:"Template1",body:[[{field:"input",name:"imie",type:"text",label:"Imię",width:"col-md-6"},{field:"input",name:"nazwisko",type:"text",label:"nazwisko",width:"col-md-6",require:!0}],[{field:"input",name:"email",type:"email",label:"email",width:"col-md-6",require:!0},{field:"input",name:"has_o",type:"password",label:"hasło",width:"col-md-6"}],[{field:"submit",label:"Add",width:"col-md-6"}]]},{title:"Template2",body:[[{field:"input",name:"imie",type:"text",label:"Imię1",width:"col-md-6"},{field:"input",name:"nazwisko1",type:"text",label:"nazwisko",width:"col-md-6",require:!0}],[{field:"input",name:"email",type:"email",label:"email2",width:"col-md-6",require:!0},{field:"input",name:"has_o",type:"password",label:"hasło2",width:"col-md-6"}]]}],d=document.createElement("div"),e='<label class="col-sm-4 control-label">Template</label><div class="col-sm-8"><select id="template" class="form-control input-sm"><option>Example template</option></select></div> ';return function(){d.setAttribute("class","form-group"),d.innerHTML=e,$(d).find("#template").append(function(){var a,b,d=document.createElement("div");return h.each(c,function(e){b=c[e],a=document.createElement("option"),h.setAttribute(a,"value",e),a.appendChild(document.createTextNode(b.title)),d.appendChild(a)}),d.innerHTML}),$(document).ready(function(){$("#form .widgets").append(d.outerHTML),$("#template").change(function(){a.body.length||(a.body=c[this.value].body,a.render())})})}(),c},MyFORM.controller=function(a,b){function r(a){var b=$(a.delegateTarget).find("#name");b.toggleClass("empty"),window.setTimeout(function(){b.toggleClass("empty")},2e3)}function s(a){k.removeClass("show"),$("#tabs li.active-tab").removeClass("active-tab"),$(a).addClass("active-tab")}function t(a){$(a).hasClass("active-option")||($(".active-option").removeClass("active-option"),$(a).addClass("active-option")),m.hasClass("active-tab")?h.addClass("show"):h.removeClass("show")}function v(){k.change()}function w(c){for(var e={},f=document.getElementById(c.delegateTarget.id).getElementsByClassName("itemField"),g=0;g<f.length;g++)e[f[g].id]="checkbox"===f[g].type?f[g].checked:f[g].value;d.push(e),"update"==c.delegateTarget.id?a.render():b.render(),x(c)}function x(a){var b=a.delegateTarget;b="preview-form"==b.id?"#update":b,$(b).find(".select-item-to-change").html(function(){var a=0,b="",c="";for(a;a<d.length;a++)b=d[a].text?d[a].text:"",c+='<option value="'+a+'">'+(a+1)+". "+b+"</option>";return'<select class="change-item form-control input-sm"><option selected>Change item</option>'+c+"</select>"}())}function y(c){var e=d[c.currentTarget.value];console.log(c),console.log(e),B(c),f=c.currentTarget.value;for(var g in e)"string"==typeof e[g]?$(c.delegateTarget).find("#items").find("input#"+g).val(e[g]):$(c.delegateTarget).find("#items").find("input#"+g).prop("checked",e[g]);$(c.delegateTarget).find("#items input").on("keyup change",function(){e[this.id]="checkbox"===this.type?this.checked:this.value,"update"==c.delegateTarget.id?a.render():b.render()})}function z(b){var c=a.clear(d[f]);d.splice(f,0,c),B(b),x(b)}function A(a){d.splice(f,1),B(a),x(a)}function B(c){var d=c.delegateTarget;d="preview-form"==d.id?"#update":d,console.log(c),$(d).find("#items").toggleClass("update"),"update"==c.delegateTarget.id?a.render():b.render()}function C(a){"delete"==a.delegateTarget.id?m.click():(B(a),$(a.delegateTarget).find("#items input").val(""),$(a.delegateTarget).find("input#checked").prop("checked",!1))}function D(c){var e=c.target.dataset,g=a.body[e.row][e.index].name;b=a.body[e.row][e.index],p.html($("#"+b.field).html()).find("#add-to-form").remove(),b.hasOwnProperty("items")&&(d=b.items,x(c)),s("#update-tab"),t(p),console.log(c);for(var h in b)b.hasOwnProperty(h)&&"field"!==h&&("string"==typeof b[h]&&$("#update #"+h).val(b[h]),"boolean"==typeof b[h]&&$("#update #"+h).prop("checked",b[h]));$("#update span input, #update span select").donetyping(function(){"name"===this.id&&g!=this.value&&a.editName(g,this.value),b[this.id]="checkbox"===this.type?this.checked:this.value,a.render()},a.time_out).on("change",function(){b[this.id]="checkbox"===this.type?this.checked:this.value,a.render()})}function E(b){var c=b.target.dataset;a.cloneField(c.row,c.index)}function F(b){var c=b.target.dataset;s(o),t("#delete"),$("button#btn-delete-confirm").unbind().click(function(){a.deleteField(c.row,c.index),a.render(),m.click()})}var c="1.1.0",d=[],f=0,g=$("#preview-form"),h=$("#preview-field"),i=$("#sidebar div.options"),j=$("#form"),k=$("select#select-field"),m=($("#form-tab"),$("#field-tab")),o=($("#update-tab"),$("#delete-tab")),p=$("#update");$("#delete");console.log("controller:",c),g.delegate(".edit","click",function(a){D(a)}).delegate(".clone","click",function(a){E(a)}).delegate(".delete","click",function(a){F(a)}),$("#tabs").on("click","li",function(a){s(a.target)}),$("#view-mode").change(function(){a.setView(this.value),a.render("off")}),i.on("click","#add-to-form",function(){a.add(b.body),v()}).on("mouseenter","#prevent-empty-name",function(a){r(a)}).on("click",".add-item",function(a){w(a)}).on("change","select.change-item",function(a){y(a)}).on("click",".clone-item-field",function(a){z(a),$("#items input").unbind()}).on("click",".delete-item-field",function(a){A(a),$("#items input").unbind()}).on("click",".back",function(a){C(a),$("#items input").unbind()}),$("#sidebar").on("click","#form-tab",function(){t("#form")}).on("click","#field-tab",function(){v()}).on("click","#save-form",function(){a.save()}),j.find("span").find("input, select").donetyping(function(){a[this.id]=this.value,a.render()},a.time_out),k.change(function(){var a=$("#"+this.value);k.addClass("show"),t(a),window.scrollTo(0,document.body.scrollHeight),a.find(".row").show(),a.find("#update-buttons").hide(),a.find("span").find("input, select, textarea").on("keyup change",function(){a.find("#add-to-form").prop("disabled",""===a.find("#name").val()),b.body[this.id]="checkbox"===this.type?this.checked:this.value,b.render()}),a.find("#items").find("input#text").on("keyup change",function(){a.find("button.add-item").prop("disabled",""===$(this).val())}),b=new MyFORM.field.factory({field:this.value}),b.uiHelper(),b.render(),d=b.body.hasOwnProperty("items")?b.body.items:[]})};
