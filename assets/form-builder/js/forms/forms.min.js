//#Copyright (c) 2016-2017 Rafal Marguzewicz pceuropa.net
"use strict";var h={isString:function(a){return typeof myVar===a||a instanceof String},is:function(a){return null===a||void 0===a||""===a},isObject:function(a){return"object"==typeof a},clearObj:function(a){for(var b in a)null!==a[b]&&void 0!==a[b]||delete a[b];return a},each:function(a,b){var c=0;for(c;c<a.length;c++)b(c,value)},setAttribute:function(a,b,c){(this.isObject(a)||this.isString(b)||this.is(c))&&a.setAttribute(b,c)},clone:function(a){var b={};for(var c in a)if(b[c])if(Array.isArray(a[c]))for(var d=0;d<a[c].length;d++)b[c][d]=a[c][d];else b[c]=a[c];return b},getName:function(){var a=/function (.{1,})\(/,b=a.exec(this.constructor.toString());return b&&b.length>1?b[1]:""},capitalizeFirstLetter:function(a){return a.charAt(0).toUpperCase()+a.slice(1)}};String.prototype.replaceAll=function(a,b){return this.replace(new RegExp(a,"g"),b)};var MyFORM=MyFORM||{};MyFORM=function(){console.log("form");var b="1.0.0",c=function(){this.title="FormBuilder",this.action="",this.method="post",this.language="English",this.body=[]};return c.prototype={questionsNames:[],constructor:c,viewMode:"html",map:{index:"0",row:"0"},config:{get:!1,save:!0,autosave:!1,create_url:document.URL,update_url:document.URL},init:function(a){return this.config=a||this.config,this.get(),MyFORM.controller(this,new MyFORM.field.factory)},clear:function(a){var b={};for(var c in a)if(a.hasOwnProperty(c)&&a[c]){if("name"===c&&(a[c]=this.filter(a[c])),"items"===c)for(var d=0;d<a[c].length;d++)""===a[c][d].value&&(a[c][d].value=d+1);b[c]=a[c]}return b},filter:function(a){var b=this.questionsNames;a=a.replace(new RegExp(/\W/,"g"),"_");for(var c in b)b[c]===a&&(a+="_2");return b.push(a),a},scenerio:function(){return this.config.save&&this.config.autosave},get:function(){var a=this;this.config.get&&$.getJSON(document.URL,function(b){console.log("upload from base correct"),a.generate(b)})},save:function(){var a=this,b=$('meta[name="csrf-token"]').attr("content"),c={};this.config.save&&(c={request_data:JSON.stringify(a),_csrf:b},$.post(document.URL,c,function(b){b.success===!0&&(console.log("save from base correct"),a.operations++,a.afterSuccessSave(),b.url&&(window.location.href=b.url))}))},editName:function(a,b){var d=$('meta[name="csrf-token"]').attr("content"),e={};console.log(this.config.save),this.config.save&&(e={change_name:{old:a,new:b},_csrf:d},$.post(document.URL,e,function(a){a.success===!0&&console.log("new name change correct")}))},postData:function(){return null},afterSuccessSave:function(){window.setTimeout(function(){$("#save-form").addClass("btn-success").prop("disabled",!0).text("Saved form correctly")},111),window.setTimeout(function(){$("#save-form").removeClass("btn-success").prop("disabled",!1).text("Save form")},1111)},add:function(a){try{a.hasOwnProperty("field")&&(this.body.push([this.clear(a)]),a.hasOwnProperty("name")&&$.post(document.URL,{add:a}),this.render())}catch(a){console.log(a),alert("Error add field to form: bad data")}},cloneField:function(a,b){var c=this.body[a][b],d=jQuery.extend(!0,{},c);d.hasOwnProperty("label")&&(d.label=c.label+"_2"),d.name=c.name+"_2",this.body[a].splice(b+1,0,d),this.render(),this.config.autosave&&(this.save(),d.hasOwnProperty("name")&&$.post(document.URL,{add_field:d}))},deleteField:function(a,b){var c=this.body[a][b];try{this.body[a].splice(b,1)&&(console.log("Delete item [",a,b,"]"),this.render(),this.config.autosave&&this.config.save&&$.ajax({url:document.URL,type:"post",dataType:"JSON",data:{delete:c.name},success:function(a){a.success===!1&&console.log(a),a.success===!0&&console.log(a)},error:function(a,b,c){alert(b)}}))}catch(c){console.log("Item [",a,b,"] not exsist")}this.config.autosave&&this.save()},addItem:function(){console.log("add item to field in form");try{for(var a=document.getElementById("update").getElementsByClassName("itemField"),b={},c=0;c<a.length;c++)b[a[c].id]="checkbox"===a[c].type?a[c].checked:a[c].value;this.body[this.map.row][this.map.index].items.push(b),this.render()}catch(a){console.log(a),alert("Error add item to field: bad id of div")}},cloneItem:function(a,b,c){var d={},e=this.body[a][b].items[c];for(var f in e)e.hasOwnProperty(f)&&(d[f]=e[f]);this.body[a][b].items.splice(c,0,d),this.render(),this.config.autosave&&this.save()},deleteItem:function(a,b,c){this.body[a][b].items.splice(c,1),this.render()},generate:function(a){this.title=a.title||"",this.action=a.action||"",this.method=a.method||"",this.id=a.id||"",this.body.class=a.class||"",this.body=a.body||{},this.body.length>0&&this.render()},attr:function(){for(var a,b="",c=arguments.length,a=0;a<c;a+=1)b+=this[arguments[a]+"Attr"]();return b},idAttr:function(){return this.id?' id="'+this.id+'"':""},classAttr:function(){return this.class?' class=" '+this.class+'"':' class=""'},rows:function(){var a="",b=this;if(0!=b.body.length)return h.each(b.body,function(c){a+=b.row(c)}),a},row:function(a){return'\n<div id="row'+a+'" class="row">\n'+this.fields(a)+" \n</div>\n"},fields:function(a){for(var b="",c=0,d=this.body[a].length;c<d;c++)b+=this.field(a,c);return b},field:function(a,b){var d=this.body[a][b],e=new MyFORM.field.factory(d);return"html"===c.prototype.viewMode&&(e.divEnd=function(){return c.prototype.edit(a,b)+"\n</div>\n"}),e.html()},render:function(){var a=$("#preview-form");switch(c.prototype.viewMode){case"text":a.html("<pre><code> </code></pre>").find("code").text(this.view("html"));break;case"json":a.html("<pre><code> </code></pre>").find("code").text(this.view("json"));break;case"yii2":a.html("<pre><code> </code></pre>").find("code").text("Yii2");break;default:a.html(this.view("html")),this.sort(this)}},view:function(a){switch(a){case"html":return'<form  action="'+this.action+'" method="'+this.method+'" '+this.attr("id","class")+">"+this.rows()+"\n</form>";case"json":return JSON.stringify(this,null,4);case"h1":return this.title}},setEdit:function(a,b){c.prototype.beforeEndDiv=this.edit(a,b)},setView:function(a){c.prototype.viewMode=a||""},edit:function(a,b){function d(a,b,c){return'<span class="glyphicon '+c+'" data-row="'+a+'" data-index="'+b+'" aria-hidden="true"></span>'}return"html"===c.prototype.viewMode?'<div class="edit-field pull-right">'+d(a,b,"edit glyphicon-pencil")+d(a,b,"clone glyphicon-duplicate")+d(a,b,"delete glyphicon-trash")+"</div>":null},sort:function(){for(var a=this,b=function(a){return a.substring(3)},c=this.body.length;c--;){var d=document.getElementById("row"+c);Sortable.create(d,{group:"row",animation:0,ghostClass:"ghost",onAdd:function(c){var d=b(c.from.id),e=b(c.target.id),f=c.oldIndex,g=c.newIndex,h=a.body[d].splice(f,1)[0];a.body[e].splice(g,0,h),a.render()},onUpdate:function(c){var d=b(c.from.id),e=c.oldIndex,f=c.newIndex;a.body[d].splice(f,0,a.body[d].splice(e,1)[0]),a.render()}})}}},{version:b,Form:c}}(),MyFORM.field=function(){var a=function(a){this.body=a||{},this.init()};a.prototype={constructor:a,view:!0,init:function(){this.set(MyFORM.field[this.body.field])},uiHelper:function(){var a=this;!function(){for(var c=document.getElementById(a.body.field).getElementsByClassName("data-source"),d=0;d<c.length;d++)a.body[c[d].id]="checkbox"===c[d].type?c[d].checked:c[d].value}(),function(){""==$("#"+a.body.field+" #name").val()&&($(this).css("color","red"),$(this).val(a.body.field))}()},set:function(a){a=a||{};for(var b in a)this[b]=a[b]},addItem:function(){try{for(var a=document.getElementById(this.body.field).getElementsByClassName("itemField"),b={},c=0;c<a.length;c++)b[a[c].id]="checkbox"===a[c].type?a[c].checked:a[c].value;this.body.items.push(b),this.render()}catch(a){console.log(a),alert("Error add item to field: bad id of div")}},render:function(){var a=$("#preview-field"),b=this;this.view?a.html("<p>Preview field: (<a>html</a>) </p>"+b.html()):a.html("<p>Preview field: (<a>text</a>)</p><pre><code> </code></pre></p>").find("code").text(b.html()),a.find("a").click(function(){b.view=!b.view,b.render()})},renderUpdateItemField:function(){var a=this;this.body.hasOwnProperty("items")&&this.body.items.length&&$("#"+a.body.field+" .select-item-to-change").html(function(){var b=0,c="",d="";for(b;b<a.body.items.length;b++)c=a.body.items[b].text?a.body.items[b].text:"",d+='<option value="'+b+'">'+(b+1)+". "+c+"</option>";return'<select class="change-item form-control input-sm"> <option selected>Change item</option>'+d+"</select>"}())},is:function(a){return a?a:""},typeAttr:function(){return this.body.type?' type="'+this.body.type+'"':""},labelAttr:function(){var a="";return this.body.require&&(a=" *"),this.body.label?"\n\t<label>"+this.body.label+a+"</label>":""},nameAttr:function(a){var a=a||!1;return a?this.body.name?' name="'+this.body.name+'[]"':"":this.body.name?' name="'+this.body.name+'"':""},valueAttr:function(){return this.body.value?' value="'+this.body.value+'"':" "},placeholderAttr:function(){return this.body.placeholder?' placeholder="'+this.body.placeholder+'"':""},idAttr:function(){return this.body.id?' id="'+this.body.id+'"':""},classAttr:function(){return this.body.class?' class="form-control '+this.body.class+'"':' class="form-control"'},dataAttr:function(){return this.body.data?' data="'+this.body.data+'"':""},rowsAttr:function(){return this.body.rows?' rows="'+this.body.rows+'"':""},checkedAttr:function(){return this.body.checked?" checked":""},requireAttr:function(){return this.body.require?" required":""},checkedAttr:function(){return this.body.require?" checked":""},helpBlockAttr:function(){return this.body.helpBlock?'\n\t<span class="help-block">'+this.body.helpBlock+"</span>":""},div:function(){return'<div class="form-group '+this.body.width+'">'},divEnd:function(){return"\n</div>"},attr:function(){for(var a,b="",c=arguments.length,a=0;a<c;a+=1)b+=this[arguments[a]+"Attr"]();return b},el:function(a){for(var b,d,c="",e=arguments.length,b=1;b<e;b+=1)d=arguments[b]+"El",c+=this[d](a);return c},labelEl:function(a){var b=this.body.items[a].text;return b?b:""},valueEl:function(a){var b=this.body.items[a].value;return b?' value="'+b+'"':' value="'+(a+1)+'"'},idEl:function(a){var b=this.body.items[a].id;return b?' id="'+b+'"':""},classEl:function(a){var b=this.body.items[a].class;return b?' class="'+b+'"':""},checkedEl:function(a){return this.body.items[a].checked?" checked":""},selectedEl:function(a){return this.body.items[a].checked?" selected":""},requireEl:function(){return this.require?" required":""},inputs:function(){var a=0,b="";for("undefined"==typeof this.body.items&&(this.body.items=[]),a;a<this.body.items.length;a++)b+=this.input(a);return b},inputHtml:function(a,b){return'<input type="'+this.is(a)+'"'+this.attr("name")+this.el(b,"value","id","class","checked","require")+">"+this.labelEl(b)},editElement:function(a){return Form.prototype.editEl.call(this,a)},glyphicon:function(a,b){return'<span class="glyphicon '+b+'" data-index="'+a+'" aria-hidden="true"></span>'},deleteItem:function(a){if(!a)throw console.log("Delete item by index:"),a;this.body.items.splice(a,1),this.render()},cloneItem:function(a){if(!a)throw console.log("Clone item by index:"),a;var b=this.body.items[a];this.body.items.splice(a,0,b),this.render()}};var b={html:function(){var a=document.createElement("input");return a.setAttribute("name",this.body.name),console.log(a),a.outerHTML}},b={html:function(){return this.div()+this.labelAttr()+"\n\t<input"+this.attr("name","type","value","placeholder","id","class","data","require")+">"+this.helpBlockAttr()+this.divEnd()}},c={html:function(){var a=this.value?this.value:"";return this.div()+this.labelAttr()+"\t<textarea "+this.attr("name","id","class","data","rows","placeholder","require")+">"+a+"</textarea>"+this.helpBlockAttr()+this.divEnd()}},d={html:function(){return this.div()+this.labelAttr()+this.inputs()+this.helpBlockAttr()+this.divEnd()},labelAttr:function(){var a="";return this.body.require&&(a=" *"),this.body.label?"\t<p>"+this.body.label+a+"</p>":""},input:function(a){return'\n\t<div class="radio"><label>'+this.inputHtml("radio",a)+"<label></div>"}},e={html:function(){return this.div()+this.labelAttr()+this.inputs()+this.helpBlockAttr()+this.divEnd()},input:function(a){return'\n\t<div class="checkbox"><label><input type="checkbox"'+this.nameAttr("multi")+this.el(a,"value","id","class","checked","require")+">"+this.labelEl(a)+"<label></div>"}},f={html:function(){return this.div()+this.labelAttr()+"\n\t<select "+this.attr("id","class","name","require")+">"+this.inputs()+"\n\t</select>"+this.helpBlockAttr()+this.divEnd()},input:function(a){return"\n\t\t<option "+this.el(a,"value","selected")+">"+this.labelEl(a)+"</option>"}},g={classAttr:function(){return this.body.class?" "+this.body.class:""},div:function(){return"<div "+this.idAttr()+' class="form-group '+this.body.width+this.classAttr()+'">'},html:function(){return this.div()+this.is(this.body.description)+this.divEnd()}},h={html:function(){return this.div()+'\t<button type="submit" class="btn btn-default">'+this.is(this.body.label)+"</button>"+this.divEnd()}};return{factory:a,input:b,textarea:c,radio:d,checkbox:e,select:f,description:g,submit:h}}(),MyFORM.controller=function(a,b){function q(a){var b=$(a.delegateTarget).find("#name");b.toggleClass("empty"),window.setTimeout(function(){b.toggleClass("empty")},2e3)}function r(a){j.removeClass("show"),$("#tabs-options li.active-tab").removeClass("active-tab"),$(a).addClass("active-tab")}function s(a){$(a).hasClass("active-option")||($(".active-option").removeClass("active-option"),$(a).addClass("active-option")),l.hasClass("active-tab")?g.addClass("show"):g.removeClass("show")}function t(){s("#options-form"),i.find("span").find("input, select").on("keyup change",function(){a[this.id]=this.value,a.render()})}function v(){j.change()}function w(d){for(var e={},f=document.getElementById(d.delegateTarget.id).getElementsByClassName("itemField"),g=0;g<f.length;g++)e[f[g].id]="checkbox"===f[g].type?f[g].checked:f[g].value;c.push(e),"update"==d.delegateTarget.id?a.render():b.render(),x(d)}function x(a){var b=a.delegateTarget;b="preview-form"==b.id?"#update":b,$(b).find(".select-item-to-change").html(function(){var a=0,b="",d="";for(a;a<c.length;a++)b=c[a].text?c[a].text:"",d+='<option value="'+a+'">'+(a+1)+". "+b+"</option>";return'<select class="change-item form-control input-sm"><option selected>Change item</option>'+d+"</select>"}())}function y(d){var f=c[d.currentTarget.value];console.log(d),console.log(f),B(d),e=d.currentTarget.value;for(var g in f)"string"==typeof f[g]?$(d.delegateTarget).find("#items").find("input#"+g).val(f[g]):$(d.delegateTarget).find("#items").find("input#"+g).prop("checked",f[g]);$(d.delegateTarget).find("#items input").on("keyup change",function(){f[this.id]="checkbox"===this.type?this.checked:this.value,"update"==d.delegateTarget.id?a.render():b.render()})}function z(b){var d=a.clear(c[e]);c.splice(e,0,d),B(b),x(b)}function A(a){c.splice(e,1),B(a),x(a)}function B(c){var d=c.delegateTarget;d="preview-form"==d.id?"#update":d,console.log(c),$(d).find("#items").toggleClass("update"),"update"==c.delegateTarget.id?a.render():b.render()}function C(a){"delete"==a.delegateTarget.id?l.click():(B(a),$(a.delegateTarget).find("#items input").val(""),$(a.delegateTarget).find("input#checked").prop("checked",!1))}function D(d){var e=d.target.dataset,g=a.body[e.row][e.index].name;b=a.body[e.row][e.index],o.html($("#"+b.field).html()).find("#add-to-form").remove(),b.hasOwnProperty("items")&&(c=b.items,x(d)),$(d.target.parentNode.parentNode).addClass("border"),r("#update-tab"),s(o),console.log(d);for(var h in b)b.hasOwnProperty(h)&&"field"!==h&&("string"==typeof b[h]&&$("#update #"+h).val(b[h]),"boolean"==typeof b[h]&&$("#update #"+h).prop("checked",b[h]));$("#update span input, #update span select").donetyping(function(){"name"===this.id&&(this.nextElementSibling.innerHTML=""===this.value?"Field name isn't empty":"",g!=this.value&&a.editName(g,this.value)),b[this.id]="checkbox"===this.type?this.checked:this.value,a.render()}).on("change",function(){b[this.id]="checkbox"===this.type?this.checked:this.value,a.render()})}function E(b){var c=b.target.dataset;a.cloneField(c.row,c.index)}function F(b){var c=b.target.dataset;a.body[c.row][c.index];r(n),s("#delete"),$("button#btn-delete-confirm").click(function(){a.deleteField(c.row,c.index),a.render(),l.click()})}console.log("controller");var c=[],e=0,f=$("#preview-form"),g=$("#preview-field"),h=$("#sidebar div.options"),i=$("#options-form"),j=$("select#select-field"),l=($("#form-tab"),$("#field-tab")),n=($("#update-tab"),$("#delete-tab")),o=$("#update");$("#delete");f.delegate(".edit","click",function(a){D(a)}).delegate(".clone","click",function(a){E(a)}).delegate(".delete","click",function(a){F(a)}),$("#view-mode").change(function(){a.setView(this.value),a.render()}),h.on("click","#add-to-form",function(){a.add(b.body),v()}).on("mouseenter","#prevent-empty-name",function(a){q(a)}).on("click",".add-item",function(a){w(a)}).on("change","select.change-item",function(a){y(a)}).on("click",".clone-item-field",function(a){z(a),$("#items input").unbind()}).on("click",".delete-item-field",function(a){A(a),$("#items input").unbind()}).on("click",".back",function(a){C(a),$("#items input").unbind()}),$("ul#tabs-options").on("click","li",function(a){r(a.target)}),$("#sidebar").on("click","#form-tab",function(){t()}).on("click","#field-tab",function(){v()}).on("click","#save-form",function(){a.save()}),j.change(function(){j.addClass("show");var a=$("#"+this.value);s(a),window.scrollTo(0,document.body.scrollHeight),a.find(".row").show(),a.find("#update-buttons").hide(),a.find("span").find("input, select, textarea").on("keyup change",function(){a.find("#add-to-form").prop("disabled",""===a.find("#name").val()),b.body[this.id]="checkbox"===this.type?this.checked:this.value,b.render()}),a.find("#items").find("input#text").on("keyup change",function(){a.find("button.add-item").prop("disabled",""===$(this).val())}),b=new MyFORM.field.factory({field:this.value}),b.uiHelper(),b.render(),c=b.body.hasOwnProperty("items")?b.body.items:[]}),function(a){a.fn.extend({donetyping:function(b,c){c=c||1e3;var d,e=function(a){d&&(d=null,b.call(a))};return console.log("text1"),this.each(function(b,f){var g=a(f);g.is(":input")&&g.on("keyup keypress paste",function(a){"keyup"==a.type&&8!=a.keyCode||(d&&clearTimeout(d),d=setTimeout(function(){e(f)},c))}).on("blur",function(){e(f)})})}})}(jQuery)};
